<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SustainWear – Staff Dashboard</title>

  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="staff.css" />
</head>
<body>

  <header class="top-nav">
    <div class="logo-title">
      <img src="images/logo.png" alt="SustainWear logo" id="logo">
      <span class="brand-name">SustainWear</span>
    </div>

    <nav class="top-menu">
      <a href="home.html">Home</a>
      <a href="login.html">Logout</a>
    </nav>
  </header>

  <div class="layout">
    <aside class="sidebar">
      <ul>
        <li class="active">Pending donations</li>
        <li>Approved donations</li>
        <li>Inventory</li>
      </ul>
    </aside>

    <main class="main-content">
      <div class="donation-box">
        <h1>Staff dashboard</h1>
        <p class="subtitle">
          Review incoming donations from donors and approve or reject them.
        </p>

        <section class="history-section">
          <h2>Pending donation requests</h2>

          <div id="requests-container" class="donation-history-list">
            <p>Loading pending donation requests...</p>
          </div>
        </section>
      </div>
    </main>
  </div>

  <script src="authhandlers.js"></script>

  <script>
    async function loadRequests() {
      const container = document.getElementById('requests-container');
      container.innerHTML = '<p>Loading pending donation requests...</p>';

      try {
        const res = await fetch('http://localhost:2000/staff/donations');
        const requests = await res.json();

        container.innerHTML = '';

        if (!requests || requests.length === 0) {
          container.innerHTML = '<p>No pending donation requests.</p>';
          return;
        }

        requests.forEach(request => {
          const card = document.createElement('div');
          card.className = 'request-card';

          card.innerHTML = `
            <h3>Donor: ${request.donor_name}</h3>
            <p><strong>Item:</strong> ${request.category} → ${request.subcategory}</p>
            <p><strong>Size:</strong> ${request.size}</p>
            <p><strong>Condition:</strong> ${request.condition}</p>
            <p><strong>Notes:</strong> ${request.description || 'None'}</p>

            <form class="response-form">
              <input type="hidden" name="id" value="${request.id}" />

              <label>Decision:</label>
              <select name="decision" required>
                <option value="">Select</option>
                <option value="accept">Accept</option>
                <option value="decline">Decline</option>
              </select>

              <label>Reason (if rejecting):</label>
              <select name="reason">
                <option value="">Select</option>
                <option value="not_needed">Not needed</option>
                <option value="quality">Quality concerns</option>
                <option value="duplicate">Duplicate item</option>
              </select>

              <label>Custom message:</label>
              <textarea
                name="custom_message"
                rows="3"
                placeholder="Optional custom message to the donor"
              ></textarea>

              <button type="submit" class="submit-btn" style="margin-top:12px;">
                Submit decision
              </button>
            </form>
          `;

          container.appendChild(card);
        });

        document.querySelectorAll('.response-form').forEach(form => {
          form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(form);
            const id = formData.get('id');
            const decision = formData.get('decision');

            if (!id || !decision) {
              alert('Please choose a decision.');
              return;
            }

            const endpoint =
              decision === 'accept'
                ? 'http://localhost:2000/staff/donations/approve'
                : 'http://localhost:2000/staff/donations/reject';

            try {
              const res = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id })
              });

              const result = await res.json();
              alert(result.message || 'Donation updated.');
              loadRequests();
            } catch (err) {
              console.error(err);
              alert('Failed to submit response.');
            }
          });
        });

      } catch (err) {
        console.error(err);
        container.innerHTML = '<p>Failed to load donation requests.</p>';
      }
    }

    document.addEventListener('DOMContentLoaded', loadRequests);
  </script>

</body>
</html>
