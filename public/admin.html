<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SustainWear Admin Dashboard</title>
  <link rel="stylesheet" href="admin-dashboard.css">
</head>
<body>

  <header class="top-nav">
    <div class="logo-title">
      <img src="images/logo.jpeg" alt="SustainWear Logo" id="logo">
      <span class="brand-name">SustainWear Admin</span>
    </div>

    <nav class="top-menu">
      <div id="userDisplay">Welcome,</div>
      <button id="logoutBtn" type="button">Logout</button>
    </nav>
  </header>

  <div class="layout">

    <aside class="sidebar">
      <div class="sidebar-title">SustainWear Admin</div>
      <ul>
        <li id="navDashboard" class="active" onclick="showSection('dashboard')">Dashboard</li>
        <li id="navLeaderboard" onclick="showSection('leaderboard')">Leaderboard</li>
      </ul>
    </aside>

    <main class="content">

      <section id="dashboard">
        <h1>Admin Dashboard</h1>

        <div class="stats-grid">
          <div class="stat-card">
            <p class="label">Total Users</p>
            <p class="value" id="statTotalUsers">0</p>
          </div>

          <div class="stat-card">
            <p class="label">Donors</p>
            <p class="value" id="statTotalDonors">0</p>
          </div>

          <div class="stat-card">
            <p class="label">Approved Staff</p>
            <p class="value" id="statStaffApproved">0</p>
          </div>

          <div class="stat-card">
            <p class="label">Pending Staff</p>
            <p class="value" id="statStaffPending">0</p>
          </div>
        </div>

        <h2>User Accounts</h2>
        <table class="data-table">
          <thead>
            <tr>
              <th>ID</th><th>Name</th><th>Email</th><th>Role</th><th>Status</th>
            </tr>
          </thead>
          <tbody id="usersTableBody"></tbody>
        </table>

        <h2>Pending Staff Accounts</h2>
        <ul id="staffList" class="list"></ul>
      </section>

      <section id="leaderboard" style="display:none;">
        <h1>Donation Leaderboard</h1>

        <div class="row">
          <div class="col stat-card">
            <div class="stat-label">Most Donated Category</div>
            <div class="stat-value" id="topCategory">–</div>
          </div>

          <div class="col stat-card">
            <div class="stat-label">Most Donated Size</div>
            <div class="stat-value" id="topSize">–</div>
          </div>
        </div>
      </section>

    </main>

  </div>

  <script>
    async function loadStats() {
      const res = await fetch("/admin/stats", { credentials: "include" });
      const s = await res.json();
      statTotalUsers.textContent = s.totalUsers;
      statTotalDonors.textContent = s.totalDonors;
      statStaffApproved.textContent = s.staffApproved;
      statStaffPending.textContent = s.staffPending;
    }

    async function loadUsers() {
      const res = await fetch("/admin/users", { credentials: "include" });
      const users = await res.json();
      usersTableBody.innerHTML = "";
      users.forEach(u => {
        usersTableBody.innerHTML += `
          <tr>
            <td>${u.id}</td>
            <td>${u.name}</td>
            <td>${u.email}</td>
            <td>${u.role}</td>
            <td>${u.status}</td>
          </tr>`;
      });
    }

    async function loadStaff() {
      const res = await fetch("/admin/pending-staff", { credentials: "include" });
      const staff = await res.json();
      staffList.innerHTML = "";
      staff.forEach(u => {
        staffList.innerHTML += `
          <li class="list-item">
            <div class="staff-left">
              <b>${u.name}</b> <span class="muted">(${u.email})</span>
            </div>
            <div class="staff-actions">
              <button type="button" onclick="approveStaff(${u.id})">Approve</button>
              <button type="button" class="danger" onclick="rejectStaff(${u.id})">Reject</button>
            </div>
          </li>`;
      });
    }

    async function loadLeaderboard() {
      const res = await fetch("/admin/leaderboard", { credentials: "include" });
      const data = await res.json();
      topCategory.textContent = data.topCategory || "–";
      topSize.textContent = data.topSize || "–";
    }

    function showSection(section) {
      dashboard.style.display = section === "dashboard" ? "block" : "none";
      leaderboard.style.display = section === "leaderboard" ? "block" : "none";

      navDashboard.classList.toggle("active", section === "dashboard");
      navLeaderboard.classList.toggle("active", section === "leaderboard");

      if (section === "leaderboard") loadLeaderboard();
    }

    function approveStaff(id) {
      fetch("/admin/approve", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ id })
      }).then(refreshAll);
    }

    function rejectStaff(id) {
      fetch("/admin/reject", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ id })
      }).then(refreshAll);
    }

    async function updateUserDisplay() {
      try {
        const res = await fetch("/api/me", { credentials: "include" });
        const data = await res.json();
        if (data.loggedIn) {
        userDisplay.textContent = `Welcome, ${data.name}`;

        } else {
          userDisplay.textContent = "Welcome,";
        }
      } catch (err) {
        console.error(err);
      }
    }

    async function logout() {
      await fetch("/logout", { method: "POST", credentials: "include" });
      window.location.href = "/login.html";
    }

    function refreshAll() {
      loadStats();
      loadUsers();
      loadStaff();
    }

    document.addEventListener("DOMContentLoaded", () => {
      updateUserDisplay();
      logoutBtn.addEventListener("click", logout);
      refreshAll();
    });
  </script>

</body>
</html>
